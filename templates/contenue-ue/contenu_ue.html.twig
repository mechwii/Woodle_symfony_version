{% extends 'base_eleve_professeur.html.twig' %}

{% block title %}Contenu UE{% endblock %}

{#Appel vers les feuilles de styles CSS#}
{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/contenu_ue/contenu_ue.css') }}">
    <link rel="stylesheet" href="{{ asset('css/contenu_ue/contenu_ue_responsive.css') }}">
{% endblock %}

{% block content %}
    {# Pour savoir si c'est un admin #}
    {% set is_admin = 'ROLE_ADMINISTRATEUR' in roles %}
    {% set vue_active = app.session.get('vue_active') %}
    {% set admin = is_admin and vue_active == 'admin' %}

    <input type="hidden" id="admin-status" value="{{ admin ? 'true' : 'false' }}">

    {#    Titre de l'UE pour savoir dans quelle UE on se situe #}
    <div class="title_ue">
        <h2>{{ ue.nom }}</h2>
        <span class="code">{{ ue.id }}</span>
    </div>

    {#    Il me faut une liste des utilisateurs qui apparait quand je clique sur un des btn stats
dedans il me faut un slider pour switch entre les deux eleves/professeurs
    #}

    {#    Partie statistiques li√©e aux statistiques concernant cette UE, on peut cliquer sur les divs pour voir qui sont sp√©cifiquement les professeurs et les √©tudiants #}
    <div class="statistiques">
        <div class="statistiques-section eleves">
            <div class="top-statistiques-section">
                <h4>Nombre d'√©l√®ves</h4>
                <svg class="svg-icon" viewBox="0 0 20 20">
                    <path
                            d="M15.573,11.624c0.568-0.478,0.947-1.219,0.947-2.019c0-1.37-1.108-2.569-2.371-2.569s-2.371,1.2-2.371,2.569c0,0.8,0.379,1.542,0.946,2.019c-0.253,0.089-0.496,0.2-0.728,0.332c-0.743-0.898-1.745-1.573-2.891-1.911c0.877-0.61,1.486-1.666,1.486-2.812c0-1.79-1.479-3.359-3.162-3.359S4.269,5.443,4.269,7.233c0,1.146,0.608,2.202,1.486,2.812c-2.454,0.725-4.252,2.998-4.252,5.685c0,0.218,0.178,0.396,0.395,0.396h16.203c0.218,0,0.396-0.178,0.396-0.396C18.497,13.831,17.273,12.216,15.573,11.624 M12.568,9.605c0-0.822,0.689-1.779,1.581-1.779s1.58,0.957,1.58,1.779s-0.688,1.779-1.58,1.779S12.568,10.427,12.568,9.605 M5.06,7.233c0-1.213,1.014-2.569,2.371-2.569c1.358,0,2.371,1.355,2.371,2.569S8.789,9.802,7.431,9.802C6.073,9.802,5.06,8.447,5.06,7.233 M2.309,15.335c0.202-2.649,2.423-4.742,5.122-4.742s4.921,2.093,5.122,4.742H2.309z M13.346,15.335c-0.067-0.997-0.382-1.928-0.882-2.732c0.502-0.271,1.075-0.429,1.686-0.429c1.828,0,3.338,1.385,3.535,3.161H13.346z">
                    </path>
                </svg>

            </div>
            <div class="bottom-stats">
                <span class="number">{{ nb_eleves_ue }}</span>
                <i class="fa-solid fa-hand-pointer"></i>
            </div>
        </div>

        <div class="statistiques-section professeurs">
            <div class="top-statistiques-section">
                <h4>Nombre d'enseignants</h4>
                <svg class="svg-icon" viewBox="0 0 20 20">
                    <path
                            d="M15.573,11.624c0.568-0.478,0.947-1.219,0.947-2.019c0-1.37-1.108-2.569-2.371-2.569s-2.371,1.2-2.371,2.569c0,0.8,0.379,1.542,0.946,2.019c-0.253,0.089-0.496,0.2-0.728,0.332c-0.743-0.898-1.745-1.573-2.891-1.911c0.877-0.61,1.486-1.666,1.486-2.812c0-1.79-1.479-3.359-3.162-3.359S4.269,5.443,4.269,7.233c0,1.146,0.608,2.202,1.486,2.812c-2.454,0.725-4.252,2.998-4.252,5.685c0,0.218,0.178,0.396,0.395,0.396h16.203c0.218,0,0.396-0.178,0.396-0.396C18.497,13.831,17.273,12.216,15.573,11.624 M12.568,9.605c0-0.822,0.689-1.779,1.581-1.779s1.58,0.957,1.58,1.779s-0.688,1.779-1.58,1.779S12.568,10.427,12.568,9.605 M5.06,7.233c0-1.213,1.014-2.569,2.371-2.569c1.358,0,2.371,1.355,2.371,2.569S8.789,9.802,7.431,9.802C6.073,9.802,5.06,8.447,5.06,7.233 M2.309,15.335c0.202-2.649,2.423-4.742,5.122-4.742s4.921,2.093,5.122,4.742H2.309z M13.346,15.335c-0.067-0.997-0.382-1.928-0.882-2.732c0.502-0.271,1.075-0.429,1.686-0.429c1.828,0,3.338,1.385,3.535,3.161H13.346z">
                    </path>
                </svg>

            </div>
            <div class="bottom-stats">
                <span class="number">{{ nb_profs_ue }}</span>
                <i class="fa-solid fa-hand-pointer"></i>
            </div>

        </div>
    </div>

    {#    Les interactions possibles avec les Publications et Sections situ√©es plus bas #}

    {% if 'ROLE_ELEVE' not in roles %}
    <div class="interactions">
        <button class="filter_button">
            <i class="fa-solid fa-filter"></i>
            Filtrer
        </button>
        <button class="sort_button">
            <i class="fa-solid fa-arrow-up-wide-short"></i>
            Trier
        </button>
        <button class="add_section">
            <i class="fa-solid fa-plus"></i>
            Ajouter une section
        </button>
    </div>
    {% endif %}

    {#    Partie √©pingl√©s, ici seront les publications √©pingl√©es #}
    <div class="epingles">
        <h3>Epingl√©s üìå</h3>
        {% if publicationsEpingles is not empty %}
            <div class="publications-epingles">

                {% for publication in publicationsEpingles %}
                    {% if publication.visible or "ROLE_PROFESSEUR" in roles %}
                        <div class="publication-epinglee">
                            <div class="post
    {% if publication.typePublicationId.id == 2 %}file
    {% elseif publication.typePublicationId.id == 3 %}calendar
    {% elseif publication.typePublicationId.id == 4 %}warning
    {% elseif publication.typePublicationId.id == 5 %}info
    {% endif %}"
                            data-id="{{ publication.id }}" >


                                <div class="top_post">
                                    <h5 class="title_post">{{ publication.titre }}</h5>
                                    <span class="date_post">{{ publication.derniereModif.date|date('d/m/Y H:i') }}</span>
                                    <span class="auteur">Epingl√© par : {{ publication.utilisateur_id_prenom }} {{ publication.utilisateur_id_nom }}</span>
{#                                    Les interactions li√©es au posts √©pingl√©s, on peut uniquement desepingl√©#}
                                    <div class="interactions_post">
                                        {% if publication.utilisateur_id_id == utilisateur.id %}
                                            <button class="desepingle_post" data-publication-id="{{ publication.id }}">
                                                <i class="fa-solid fa-thumbtack"></i></button>
                                        {% endif %}

                                    </div>
{#                                    <!-- Ic√¥ne trois points -->  cens√©e √™tre utilis√©e dans une ancienne version du responsive#}
                                    <i class="fa-solid fa-ellipsis-h ellipsis_icon"></i>

                                    <!-- Menu d'options cach√© par d√©faut, cens√© √™tre utilis√© pour une ancienne version du responsive -->
                                    <div class="options_menu">
                                        <button class="edit_post">Modifier</button>
                                        <button class="delete_post">Supprimer</button>
                                    </div>
                                </div>
{#                                Si la publication est un fichier alors au lieu d'afficher le texte du contenu on affiche le bouton de t√©l√©chargement pour le fichier#}
                                {% if publication.typePublicationId.id == 2 %}
                                    <div class="download">
                                        <i class="fa-solid fa-file-pdf"></i>
                                        <a href="{{ asset('/uploads/' ~ publication.contenuFichier) }}" download>
                                            <span class="nom_fichier">{{ publication.contenuFichier }}</span>
                                            <i class="fa-solid fa-download"></i>
                                        </a>
                                    </div>
{#                                    Sinon on affiche le contenu texte et ca veut dire qu'il n'y a pas de fichier dans la publication#}
                                {% else %}
                                    <p class="text_post">{{ publication.contenuTexte }}</p>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        {% else %}
{#            Message par d√©faut si aucune publication n'a √©t√© √©pingl√©e#}
            <p>Aucune publication √©pingl√©e.</p>
        {% endif %}
    </div>

    {# Partie liste des publications #}

    <div class="sections-wrapper">
        {# On extrait les ID des publications √©pingl√©es et on les transforme en une cha√Æne s√©par√©e par des virgules #}
        {% set publicationsEpinglesIds = publicationsEpingles|map(p => p.id)|join(',') %}
        {% for section in sections_ue %}
            <div class="section section-{{ section.id }}" data-section-id="{{ section.id }}">
                <div class="head-section">
                    <h3>{{ section.nom }}</h3>
{#                    Toutes les interactions possibles concernant une section en particulier : y ajouter un post | supprimer la section | editer le nom de la section #}
                    {% if 'ROLE_ELEVE' not in roles %}
                    <button class="add_post" data-section-id="{{ section.id }}">
                        <i class="fa-solid fa-feather"></i>
                    </button>
                    <button class="delete_section" data-section-id="{{ section.id }}">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                    <button class="edit_section">
                        <i class="fa-solid fa-edit"></i>
                    </button>
                    {% endif %}
                </div>

                {% set hasPublications = false %}
                {% for publication in liste_publications %}

                {% if (publication.section_id == section.id and publication.visible) or (publication.section_id == section.id and 'ROLE_PROFESSEUR' in roles ) %}
                {% if not hasPublications %}
                <div class="liste_posts">
                    {% set hasPublications = true %}
                    {% endif %}

{#                    Ici on attribue une classe suppl√©mentaire au post et en fonction de cette classe le style d'affichage css sera diff√©rent #}
                    <div class="post
    {% if publication.type_publication_id == 2 %}file
    {% elseif publication.type_publication_id == 3 %}calendar
    {% elseif publication.type_publication_id == 4 %}warning
    {% elseif publication.type_publication_id == 5 %}info
    {% endif %}"
                         data-id="{{ publication.id }}" data-ordre="{{ publication.ordre }}">

                        <div class="top_post">
                            <h5 class="title_post">{{ publication.titre }}</h5>
                            <span class="date_post">{{ publication.derniere_modif }}</span>
{#                            Ici les interactions li√©es √† une publication en particulier : editer le post | supprimer le post#}
                            {% if 'ROLE_ELEVE' not in roles %}

                                <div class="interactions_post">

                               {# {% if publication.utilisateur_id == utilisateur.id %} #}

                                    <button class="edit_post" data-url="{{ path('publication_edit', {
                                        codeUe: ue.id,
                                        id_section: section.id,
                                        id_publication: publication.id
                                    }) }}">
                                        <i class="fa-solid fa-pen"></i>
                                    </button>


                                    <button class="delete_post" data-publication-id="{{ publication.id }}"><i
                                                class="fa-solid fa-trash"></i></button>

                                    {# {% endif %}  #}

{#                                    Si la publication n'est pas √©pingl√©e alors le bouton pour l'√©pingler s'affiche#}
                                {% if publication.id not in publicationsEpinglesIds %}
                                    <button class="epingle_post" data-publication-id="{{ publication.id }}">
                                        <i class="fa-solid fa-thumbtack"></i>
                                    </button>
                                {% else %}

                                {% endif %}
                            </div>
                            <!-- Ic√¥ne trois points -->
                            <i style="margin-left: 10px" class="fa-solid fa-up-down-left-right drag-handle"></i>

                            <!-- Menu d'options cach√© par d√©faut -->
                            <div class="options_menu">
                                <button class="edit_post">Modifier</button>
                                <button class="delete_post">Supprimer</button>
                            </div>
                            {% endif %}
                        </div>
{#                        Si la publication est un fichier (type_publication_id = 2) alors on affiche le fichier √† t√©l√©charger, sinon le texte #}
                        {% if publication.type_publication_id == 2 %}
                            <div class="download">
                                <i class="fa-solid fa-file-pdf"></i>
                                <a href="{{ asset('/uploads/' ~ publication.contenu_fichier) }}" download>
                                    <span class="nom_fichier">{{ publication.contenu_fichier }}</span>
                                    <i class="fa-solid fa-download"></i>
                                </a>
                            </div>
                        {% else %}
                            <p class="text_post">{{ publication.contenu_texte }}</p>
                        {% endif %}
                    </div>
                    {% endif %}
                    {% endfor %}

                    {% if hasPublications %}
                </div>
{#                Si une section n'a pas de publication qui lui est associ√©e#}
            {% else %}
                <p>Aucune publication dans cette section.</p>
                {% endif %}
            </div>
        {% endfor %}
    </div>

{#    Liste des popups cach√©es qui apparaissent en fonction des interactions avec la page#}
{#    Popup qui apparait pour afficher la liste des √©tudiants / Professeurs#}
    <div class="popUpListe popup hidden">
        <div class="boutonsSwitchListes">
            <div class="switch-background-liste"></div>
            <div class="student">Etudiants</div>
            <div class="teacher">Professeurs</div>
        </div>

        <div class="containerListe">
            <div id="liste-data"
                 data-eleves='{{ liste_eleves_ue|json_encode|e('html_attr') }}'
                 data-profs='{{ liste_profs_ue|json_encode|e('html_attr') }}'>
            </div>
        </div>
    </div>

{#    Popup cach√©e qui apparait quand on clique sur un bouton pour ajouter une publication#}
    <div class="popupPublication popup hidden">
        <h3>Ecrire une nouvelle publication</h3>
        <div class="boutonsSwitch">
            <div class="switch-background"></div>
            <div class="text">Texte</div>
            <div class="file">Fichier</div>
        </div>

        <div class="formulaireContainer">
            <!-- contenu du formulaire de la template create_publication.html.twig -->
        </div>


    </div>

    {#    Popup cach√©e qui apparait quand on clique sur un bouton pour editer une section #}

    <div class="popupEditSectionContainer popup hidden">
        {#        Ici on appel en ajax le tempalte du formulaire edit de section#}
    </div>

    {#    Popup cach√©e qui apparait quand on clique sur un bouton pour ajouter une section #}
    <div class="popup popupAddSection hidden">
        {#       ici on appelle en ajax le template du formulaire create_section.html.twig #}
    </div>

    {#    Popup cach√©e de validation qui apparait quand on clique sur un bouton pour supprimer une section #}
    <div class="custom-modal hidden popup-delete-section">
        <div class="modal-content">
            <p>Es-tu s√ªr(e) de vouloir supprimer cette section ?</p>
            <div class="modal-actions">
                <button class="cancel-btn-section">Annuler</button>
                <button class="confirm-btn-section">Supprimer</button>
            </div>
        </div>
    </div>

    {#    Popup cach√©e de validation qui apparait quand on clique sur un bouton pour supprimer une publication #}
    <div class="custom-modal-post hidden popup-delete-publication">
        <div class="modal-content">
            <p>Es-tu s√ªr(e) de vouloir supprimer cette publication ?</p>
            <div class="modal-actions">
                <button class="cancel-btn-post">Annuler</button>
                <button class="confirm-btn-post">Supprimer</button>
            </div>
        </div>
    </div>

    {#    Popup cach√©e qui apparait quand on clique sur un bouton pour editer une publication #}

    <div id="editPublicationModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <div id="edit-publication-form-container">
                <!-- Le formulaire AJAX edit_publication.html.twig apparait ici -->
            </div>
        </div>
    </div>

{#    fond noir pour derriere la popup pour assombrir le reste de la page et nous permettre de nous concentrer sur la popup au milieu de l'√©cran#}
    <div class="modal-backdrop hidden"></div>

    {#    fond noir pour derriere la popup pour assombrir le reste de la page et nous permettre de nous concentrer sur la popup au milieu de l'√©cran pour des popup diff√©rentes#}
    <div class="darkBackground hidden"></div>

    {% block javascripts %}
        {{ parent() }}
        <script src="{{ asset('js/contenu_ue/contenu_ue.js') }}"></script>
        <script src="{{ asset('js/contenu_ue/drag_ordre.js') }}"></script>

    {% endblock %}
{% endblock %}
